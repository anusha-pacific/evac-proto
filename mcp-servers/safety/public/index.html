<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Safety Prototype</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root {
      --panel-w: 340px;
      --bg: #0f172a;       /* slate-900 */
      --panel: #111827;    /* gray-900 */
      --card: #1f2937;     /* gray-800 */
      --text: #e5e7eb;     /* gray-200 */
      --muted: #9ca3af;    /* gray-400 */
      --accent: #22c55e;   /* green-500 */
      --accent2:#60a5fa;   /* blue-400 */
      --warning:#f59e0b;   /* amber-500 */
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    #app { display: flex; height: 100%; }

    /* left info panel */
    #info {
      width: var(--panel-w);
      background: var(--panel);
      border-right: 1px solid rgba(255,255,255,.06);
      padding: 16px;
      overflow: auto;
    }
    #info h1 {
      margin: 0 0 8px;
      font-size: 18px;
      letter-spacing: .2px;
    }
    .subtle { color: var(--muted); }
    .row { display: flex; align-items: center; gap: 8px; margin: 8px 0; flex-wrap: wrap; }
    .chip { background: var(--card); padding: 6px 10px; border-radius: 999px; font-size: 12px; color: var(--muted); }
    .card {
      background: var(--card);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 12px;
      padding: 12px;
      margin: 12px 0;
    }
    .card h3 { margin: 0 0 6px; font-size: 14px; }
    .metric { display: grid; grid-template-columns: 1fr auto; gap: 6px; align-items: baseline; }
    .metric b { font-size: 18px; }
    .muted { color: var(--muted); }
    .scorebar {
      height: 8px; border-radius: 999px; background: rgba(255,255,255,.08); overflow: hidden; margin-top: 8px;
    }
    .scorebar > div { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); width: 0%; transition: width .25s ease; }

    .nearest { margin-top: 8px; font-size: 13px; }
    .nearest div { margin: 4px 0; }

    label.inline { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; color: var(--muted); }
    input[type="range"] { width: 100%; }

    /* map */
    #map { flex: 1; }
    .leaflet-container { background: #0b1022; }

    /* simple “ping” marker */
    .click-marker {
      background: #60a5faAA; border: 2px solid #1e3a8a; width: 14px; height: 14px; border-radius: 999px;
      box-shadow: 0 0 0 6px rgba(96,165,250,.2);
    }

    @media (max-width: 860px) {
      #info { width: 100%; height: 45%; order: 2; }
      #map { order: 1; height: 55%; }
      #app { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div id="app">
    <aside id="info">
      <h1>Area info</h1>

      <div class="card">
        <div class="metric">
          <div class="muted">Selected location</div>
          <div id="coords" class="chip">–</div>
        </div>
        <div class="row" style="margin-top:10px">
          <label for="radius" class="inline">Radius (m)</label>
          <div id="radiusVal" class="chip">1500</div>
          <input id="radius" type="range" min="300" max="5000" step="100" value="1500" />
        </div>
      </div>

      <div class="card">
        <h3>Safety score</h3>
        <div class="metric">
          <div class="muted">Composite (0–1)</div>
          <b id="score">–</b>
        </div>
        <div class="scorebar"><div id="scoreFill"></div></div>
        <div id="scoreNote" class="muted" style="margin-top:6px;font-size:12px">
          Based on nearby shelters, schools, and health facilities within the radius.
        </div>
      </div>

      <div class="card">
        <h3>Nearby places</h3>
        <div class="nearest" id="near-shelter">Shelters: –</div>
        <div class="nearest" id="near-school">Schools: –</div>
        <div class="nearest" id="near-health">Health: –</div>
      </div>

      <div class="card">
        <h3>Tips</h3>
        <div class="muted" style="font-size:12px">
          Click anywhere on the map to update. Drag the radius slider to widen/narrow the search area.
        </div>
      </div>
    </aside>

    <div id="map"></div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="">
  </script>
  <script>
    // --- helpers ---
    const $ = (id) => document.getElementById(id);
    const fmt = (n, d=0) => Number(n).toFixed(d);
    const fmtDist = (m) => m == null ? "–"
      : (m < 1000 ? `${Math.round(m)} m` : `${(m/1000).toFixed(2)} km`);

    function updatePanelLoading(isLoading) {
      $("score").textContent = isLoading ? "…" : $("score").textContent;
      $("scoreFill").style.width = isLoading ? "0%" : $("scoreFill").style.width;
    }

    function applyResult(res) {
      const healthKey = res.health ? "health" : (res.healths ? "healths" : null);

      $("score").textContent = res.score?.toFixed?.(2) ?? "0.00";
      $("scoreFill").style.width = `${Math.max(0, Math.min(1, res.score || 0)) * 100}%`;

      const mkNearest = (bucket, label) => {
        if (!bucket) return `${label}: –`;
        const c = bucket.count ?? 0;
        const n = bucket.nearest;
        if (c === 0 && !n) return `${label}: 0 found`;
        const name = n?.name ?? "closest";
        const dist = fmtDist(n?.distance_m);
        return `${label}: ${c} found — nearest: ${name} (${dist})`;
      };

      $("near-shelter").textContent = mkNearest(res.shelters, "Shelters");
      $("near-school").textContent  = mkNearest(res.schools,  "Schools");
      $("near-health").textContent  = mkNearest(healthKey ? res[healthKey] : null, "Health");
    }

    // --- map setup ---
    const map = L.map("map").setView([35.44, 139.64], 12); // Yokohama-ish
    L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      { attribution: '&copy; OpenStreetMap', maxZoom: 19 }
    ).addTo(map);

    let clickMarker = null;
    let radiusCircle = null;

    function setMarker(lat, lon, radius) {
      if (!clickMarker) {
        clickMarker = L.marker([lat, lon], {
          icon: L.divIcon({ className: "click-marker" })
        }).addTo(map);
      } else {
        clickMarker.setLatLng([lat, lon]);
      }
      if (!radiusCircle) {
        radiusCircle = L.circle([lat, lon], { radius, opacity: 0.6, fillOpacity: 0.08 });
        radiusCircle.addTo(map);
      } else {
        radiusCircle.setLatLng([lat, lon]);
        radiusCircle.setRadius(radius);
      }
    }

    async function scoreAt(lat, lon, radius) {
      $("coords").textContent = `lat ${fmt(lat, 5)}, lon ${fmt(lon, 5)}`;
      $("radiusVal").textContent = radius;

      setMarker(lat, lon, radius);
      updatePanelLoading(true);

      try {
        const url = `/score?lon=${encodeURIComponent(lon)}&lat=${encodeURIComponent(lat)}&radius=${encodeURIComponent(radius)}`;
        const res = await fetch(url);
        if (!res.ok) {
          const t = await res.text();
          throw new Error(`Server ${res.status}: ${t}`);
        }
        const json = await res.json();
        applyResult(json);
      } catch (e) {
        console.error(e);
        $("score").textContent = "0.00";
        $("scoreFill").style.width = "0%";
        $("near-shelter").textContent = "Shelters: error";
        $("near-school").textContent  = "Schools: error";
        $("near-health").textContent  = "Health: error";
      } finally {
        updatePanelLoading(false);
      }
    }

    // click to query
    map.on("click", (ev) => {
      const radius = Number($("radius").value);
      scoreAt(ev.latlng.lat, ev.latlng.lng, radius);
    });

    // slider to re-query at same point
    $("radius").addEventListener("input", (ev) => {
      $("radiusVal").textContent = ev.target.value;
      if (clickMarker) {
        const ll = clickMarker.getLatLng();
        scoreAt(ll.lat, ll.lng, Number(ev.target.value));
      }
    });

    // initial query at center
    (function init() {
      const c = map.getCenter();
      scoreAt(c.lat, c.lng, Number($("radius").value));
    })();
  </script>
</body>
</html>
